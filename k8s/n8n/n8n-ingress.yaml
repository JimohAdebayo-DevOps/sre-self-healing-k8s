apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: n8n
  namespace: n8n
  annotations:
    # Legacy class annotation (keep for safety)
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-cloudflare
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    
    # AUTH HANDSHAKE:
    # Internal cluster DNS call (fastest and bypasses Cloudflare)
    nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.oauth2-proxy.svc.cluster.local:4180/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://n8n.sikiru.co.uk/oauth2/start?rd=$scheme://$host$request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email"
    
    # 501 ERROR FIX (Forcing GET method):
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_method GET;
      proxy_set_header X-Forwarded-Proto $scheme;

spec:
  # 4. CRITICAL: Picks up the rules and prevents "ignoring ingress" logs
  ingressClassName: nginx 
  tls:
    - hosts:
        - n8n.sikiru.co.uk
      secretName: n8n-tls3
  rules:
    - host: n8n.sikiru.co.uk
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: n8n
                port:
                  number: 5678
