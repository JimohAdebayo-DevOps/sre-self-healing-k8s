auth:
  adminUser: admin
  existingSecret: keycloak-admin-secret
  passwordKey: admin-password

# Image fix for Bitnami Legacy
image:
  registry: docker.io
  repository: bitnamilegacy/keycloak
  tag: 26.3.3-debian-12-r0

# Database Configuration
postgresql:
  enabled: false

externalDatabase:
  host: postgresql-db.n8n.svc.cluster.local
  port: 5432
  user: keycloak
  database: keycloak
  existingSecret: keycloak-db-secret
  existingSecretPasswordKey: password

# Keycloak 26 Proxy Fix
# This resolves the "WARNING: Likely misconfiguration detected"
proxy: edge
extraEnvVars:
  - name: KC_PROXY_HEADERS
    value: "xforwarded"
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"

# Resources for your 20GB RAM cluster
resources:
  limits:
    memory: 2Gi
    cpu: 1000m
  requests:
    memory: 1Gi
    cpu: 500m

ingress:
  enabled: true
  ingressClassName: nginx
  hostname: sso.sikiru.co.uk
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-cloudflare
    # THE FIX: Matches your successful patch
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    # THE PREVENTATIVE FIX: Prevents "400 Bad Request" on login
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "256k"
  tls:
    - secretName: sso.sikiru.co.uk-tls
      hosts:
        - sso.sikiru.co.uk

extraEnvVars:
  - name: KC_PROXY_HEADERS
    value: "xforwarded"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HOSTNAME
    value: "https://sso.sikiru.co.uk"
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "false"
